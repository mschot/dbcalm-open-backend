services:
  test-runner:
    build:
      context: ../${DISTRO_DIR:-debian}
      dockerfile: Dockerfile
      args:
        DB_TYPE: ${DB_TYPE:-mariadb}
    volumes:
      - ../artifacts:/tests/artifacts:ro
      - ../test-results:/tests/test-results:rw
      - ../../../:/app:ro  # Mount entire backend directory for test access
      - ./scripts:/tests/scripts:ro  # Mount common scripts
      - ./fixtures:/tests/fixtures:ro  # Mount common fixtures
    environment:
      - PYTHONPATH=/app
      - E2E_TEST_MODE=true
      - API_BASE_URL=https://localhost:8335
      - DISTRO=${DISTRO:-debian}
      - DB_TYPE=${DB_TYPE:-mariadb}
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
    privileged: true
    working_dir: /app/tests/e2e/common
    networks:
      - dbcalm-test

networks:
  dbcalm-test:
    driver: bridge
